//import groovy.json.JsonSlurper
def putaws() {
//    echo "Hello environment ${environment} from putaws function. Executing on the $environment branch. Values of ${} = ${httpq1}, webhook = ${webhook1} and apimgr = ${apimgr1}"
    //echo "aws ssm put-parameter --name /${environment}/terraform/docker_images/httpq_image --value {accountid}.dkr.ecr.us-east-1.amazonaws.com/httpq:${httpq1} --overwrite  --type String"
   // sh "yamllint services.yml"
    //println "config.vm.ip = ${config.vm.ip}"
//    echo "config.vm.ip = ${config.vm.ip}"
    sh "ls -ltrh configdata_${params['environment']}.json"



list.each {
//env.dc_cocc_bankgloucester = it.dc_cocc_bankgloucester
env.clientname = it.clientname
env.releasenumber = it.releasenumber
//env.VMmemory = it.memory
env.clientname_count = it.clientname_count
echo "Executing on Environment $environment. Values of Application = ${clientname}" 
echo "Executing on Environment $environment. Values of Application = ${clientname} and count is ${clientname_count}"

//echo "Executing on Environment $environment. Values of Application = ${dc_cocc_bankgloucester}"
}
}


import groovy.json.JsonSlurper
pipeline {
    agent any
parameters {
//    string(name: 'sso', defaultValue: '', description: 'which SSO we want to execute')
 //   choice(name: 'environment', choices: ['dev1', 'dev2', 'dev3', 'prod', 'imp1', 'conv'], description: 'on which environment to execute')
//    booleanParam(name: 'executefunctionstep', defaultValue: true, description: 'execute only if true')
	string(name: 'dc_cocc_bankgloucester_count', defaultValue: '0', description: 'Count for dc_cocc_bankgloucester value')
	string(name: 'dc_cocc_baycoast_count', defaultValue: '0', description: 'Count for dc_cocc_baycoast value')
}


    stages {
       stage('Read the variables of service and versions') {
          steps {
                script {
        echo "Hello from Environment ${environment}"
      def envlist = environment.split(',').collect{it as String}
        envlist.each {
                echo "Working on ${it} environment"
                env.environment = it
                echo "Working on ${it} environment"
		sh "ls -ltrh configdata.json"
		def exists = fileExists "configdata_${params['environment']}.json"
		//def exists = fileExists "configdata_${environment}.json"
		echo "-------------------------------------------------------"
	        //echo "Looking for configdata_${params['environment']}.json:"
	        echo "Looking for configdata_${environment}.json:"
        	if (exists) {
	            //echo "configdata_${params['environment']}.json found"
	            echo "configdata_${environment}.json found"
        	} else {
	            // sendErrorMessageToHipchat("Cannot find configdata_${params['environment']}.json file.")
        	    //error("configdata_${params['environment']}.json cannot be found")
        	    error("configdata_${environment}.json cannot be found")
         	}
          echo "-------------------------------------------------------"



//		def config = readJSON file: "configdata.json"
                def config = readJSON file: "configdata_${params['environment']}.json"
//    		echo "config.vm.ip = ${config.vm.ip}"
		echo "going into list function"
		list=config.deploy

//		def jsonSlurper = new JsonSlurper()
//		def config = jsonSlurper.parse(new File('configdata.json'))
//		def datas = readYaml file: 'services.yml'
//		httpq1=datas."${environment}".httpq
//		webhook1=datas."${environment}".webhook003
//		apimgr1=datas."${environment}".apimgr
                //echo "Got  httpq ${httpq1} from ${environment} environment"
                //echo "Got  webhook as ${webhook1} from ${environment} environment"
                //echo "Got  apimgr as ${apimgr1} from ${environment} environment"
}
                       }
                }
                                                                }
       stage('Execute based on Environment') {
          steps {
                script {
			if (environment == 'prod' || environment == 'imp1' || environment == 'conv') {
//                        	echo "Executing on the $environment branch. Values of httpq = ${httpq1}, webhook = ${webhook1} and apimgr = ${apimgr1}"
				putaws()

	                    } else if (environment == 'dev1' || environment == 'dev2' ||  environment == 'dev3' || environment == 'qa1' ) {
//                                echo "Executing on the $environment branch. Values of httpq = ${httpq1}, webhook = ${webhook1} and apimgr = ${apimgr1}"
				putaws()
                            } else if (environment == 'pref' || environment == 'qa2') {
//                                echo "Executing on the $environment branch. Values of httpq = ${httpq1}, webhook = ${webhook1} and apimgr = ${apimgr1}"
				putaws()
                            } else if (environment == 'uat1') {
//                                echo "Executing on the $environment branch. Values of httpq = ${httpq1}, webhook = ${webhook1} and apimgr = ${apimgr1}"
				putaws()
                            } else {
        	                echo 'No Matching environment found....... '
                	    	   }
                       }
                }
                                                                }


// End
}
}
